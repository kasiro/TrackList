<!DOCTYPE html>
<html lang="ru">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>TrackList - Учет бюджета</title>
    <script src="https://cdn.jsdelivr.net/npm/@tailwindcss/browser@4"></script>
    <script src="https://unpkg.com/vue@3/dist/vue.global.js"></script>
    <script src="https://unpkg.com/lucide@latest/dist/umd/lucide.js"></script>
    <link href="https://fonts.googleapis.com/css2?family=Inter:wght@400;500;600;700&display=swap" rel="stylesheet">
    <style>
        * { font-family: 'Inter', sans-serif; }
        [v-cloak] { display: none; }
        
        input[type="number"]::-webkit-inner-spin-button,
        input[type="number"]::-webkit-outer-spin-button {
            -webkit-appearance: none;
            margin: 0;
        }
        input[type="number"] { -moz-appearance: textfield; }
        
        .sidebar-overlay {
            transition: opacity 0.3s ease;
        }
        .sidebar-panel {
            transition: transform 0.3s ease;
        }
        
        .no-scrollbar::-webkit-scrollbar {
            display: none;
        }
        .no-scrollbar {
            -ms-overflow-style: none;
            scrollbar-width: none;
        }
        
        .toast-enter-active {
            animation: slideIn 0.3s ease;
        }
        .toast-leave-active {
            animation: slideOut 0.3s ease;
        }
        @keyframes slideIn {
            from { transform: translateX(100%); opacity: 0; }
            to { transform: translateX(0); opacity: 1; }
        }
        @keyframes slideOut {
            from { transform: translateX(0); opacity: 1; }
            to { transform: translateX(100%); opacity: 0; }
        }
        
        .modal-enter-active {
            animation: fadeIn 0.2s ease;
        }
        .modal-leave-active {
            animation: fadeOut 0.2s ease;
        }
        @keyframes fadeIn {
            from { opacity: 0; }
            to { opacity: 1; }
        }
        @keyframes fadeOut {
            from { opacity: 1; }
            to { opacity: 0; }
        }
    </style>
</head>
<body class="bg-gray-100 min-h-screen text-gray-900">
    <div id="app" v-cloak>
        
        <!-- Toast Container -->
        <div class="fixed top-4 right-4 z-[100] space-y-2 max-w-sm">
            <transition-group name="toast">
                <div 
                    v-for="toast in toasts" 
                    :key="toast.id"
                    class="flex items-center gap-3 px-4 py-3 rounded-lg shadow-lg border"
                    :class="{
                        'bg-green-50 border-green-200 text-green-800': toast.type === 'success',
                        'bg-red-50 border-red-200 text-red-800': toast.type === 'error',
                        'bg-blue-50 border-blue-200 text-blue-800': toast.type === 'info',
                        'bg-orange-50 border-orange-200 text-orange-800': toast.type === 'warning'
                    }"
                >
                    <i :data-lucide="getToastIcon(toast.type)" class="w-5 h-5 flex-shrink-0"></i>
                    <span class="text-sm font-medium flex-1">{{ toast.message }}</span>
                    <button @click="removeToast(toast.id)" class="p-1 hover:opacity-70 flex-shrink-0">
                        <i data-lucide="x" class="w-4 h-4"></i>
                    </button>
                </div>
            </transition-group>
        </div>
        
        <!-- Confirm Modal -->
        <transition name="modal">
            <div v-if="confirmModal.show" class="fixed inset-0 z-[90] flex items-center justify-center p-4">
                <div class="absolute inset-0 bg-black/50" @click="cancelConfirm"></div>
                <div class="relative bg-white rounded-xl shadow-xl max-w-sm w-full p-6">
                    <div class="flex items-center gap-3 mb-4">
                        <div class="w-10 h-10 rounded-full bg-red-100 flex items-center justify-center flex-shrink-0">
                            <i data-lucide="alert-triangle" class="w-5 h-5 text-red-600"></i>
                        </div>
                        <h3 class="text-lg font-semibold text-gray-900">{{ confirmModal.title }}</h3>
                    </div>
                    <p class="text-gray-600 mb-6">{{ confirmModal.message }}</p>
                    <div class="flex gap-3">
                        <button 
                            @click="cancelConfirm"
                            class="flex-1 px-4 py-2.5 border border-gray-300 rounded-lg font-medium text-gray-700 hover:bg-gray-50 transition-colors"
                        >
                            Отмена
                        </button>
                        <button 
                            @click="executeConfirm"
                            class="flex-1 px-4 py-2.5 bg-red-500 hover:bg-red-600 rounded-lg font-medium text-white transition-colors"
                        >
                            Удалить
                        </button>
                    </div>
                </div>
            </div>
        </transition>
        
        <!-- Mobile Header -->
        <header class="lg:hidden fixed top-0 left-0 right-0 bg-white border-b border-gray-200 z-40">
            <div class="flex items-center justify-between px-4 py-3">
                <button @click="sidebarOpen = true" class="p-2 hover:bg-gray-100 rounded-lg">
                    <i data-lucide="menu" class="w-5 h-5"></i>
                </button>
                <div class="flex items-center gap-2">
                    <div class="w-7 h-7 bg-blue-500 rounded-lg flex items-center justify-center">
                        <i data-lucide="wallet" class="w-3.5 h-3.5 text-white"></i>
                    </div>
                    <span class="font-bold">TrackList</span>
                </div>
                <div class="w-10"></div>
            </div>
        </header>
        
        <!-- Mobile Sidebar Overlay -->
        <div 
            v-if="sidebarOpen" 
            @click="sidebarOpen = false"
            class="sidebar-overlay lg:hidden fixed inset-0 bg-black/50 z-40"
        ></div>
        
        <!-- Sidebar -->
        <aside 
            class="sidebar-panel fixed lg:static top-0 left-0 h-full w-[280px] bg-white border-r border-gray-200 z-50 flex flex-col overflow-hidden"
            :class="sidebarOpen ? 'translate-x-0' : '-translate-x-full lg:translate-x-0'"
        >
            <!-- Logo -->
            <div class="p-4 border-b border-gray-200 flex-shrink-0">
                <div class="flex items-center justify-between">
                    <div class="flex items-center gap-2">
                        <div class="w-8 h-8 bg-blue-500 rounded-lg flex items-center justify-center flex-shrink-0">
                            <i data-lucide="wallet" class="w-4 h-4 text-white"></i>
                        </div>
                        <h1 class="text-lg font-bold text-gray-900">TrackList</h1>
                    </div>
                    <button @click="sidebarOpen = false" class="lg:hidden p-2 hover:bg-gray-100 rounded-lg flex-shrink-0">
                        <i data-lucide="x" class="w-5 h-5"></i>
                    </button>
                </div>
            </div>
            
            <!-- Budget Input -->
            <div class="p-4 border-b border-gray-200 flex-shrink-0">
                <label class="text-xs font-medium text-gray-500 uppercase tracking-wide mb-2 block">Бюджет</label>
                <div class="relative">
                    <input 
                        type="number" 
                        v-model.number="budget" 
                        @input="saveData"
                        class="w-full border border-gray-300 rounded-lg px-3 py-2.5 text-lg font-semibold focus:ring-2 focus:ring-blue-500 focus:border-blue-500 focus:outline-none"
                        placeholder="0"
                    >
                    <span class="absolute right-3 top-1/2 -translate-y-1/2 text-gray-400">₽</span>
                </div>
            </div>
            
            <!-- Quick Stats -->
            <div class="p-4 border-b border-gray-200 flex-shrink-0">
                <div class="flex justify-between items-center py-1">
                    <div class="flex items-center gap-2 text-sm text-gray-600">
                        <i data-lucide="trending-down" class="w-4 h-4 flex-shrink-0"></i>
                        <span>Потрачено</span>
                    </div>
                    <span class="font-semibold text-gray-900">{{ formatMoney(totalSpent) }} ₽</span>
                </div>
            </div>
            
            <!-- Lists Navigation -->
            <div class="flex-1 overflow-y-auto overflow-x-hidden no-scrollbar">
                <div class="p-4">
                    <div class="flex items-center justify-between mb-3">
                        <h3 class="text-xs font-medium text-gray-500 uppercase tracking-wide">Списки</h3>
                        <span class="text-xs text-gray-400 bg-gray-100 px-1.5 py-0.5 rounded">{{ trackLists.length }}</span>
                    </div>
                    
                    <!-- Add List -->
                    <div class="flex gap-2 mb-4">
                        <input 
                            type="text" 
                            v-model="newListTitle" 
                            @keyup.enter="addList"
                            class="flex-1 min-w-0 border border-gray-300 rounded-lg px-3 py-2 text-sm focus:ring-2 focus:ring-blue-500 focus:border-blue-500 focus:outline-none"
                            placeholder="Новый список..."
                        >
                        <button 
                            @click="addList"
                            class="bg-blue-500 hover:bg-blue-600 p-2 rounded-lg text-white transition-colors flex-shrink-0"
                        >
                            <i data-lucide="plus" class="w-5 h-5"></i>
                        </button>
                    </div>
                    
                    <!-- Lists -->
                    <div class="space-y-2">
                        <div 
                            v-for="list in trackLists" 
                            :key="list.id"
                            @click="selectList(list.id); sidebarOpen = false"
                            class="p-3 rounded-lg cursor-pointer border transition-all"
                            :class="selectedListId === list.id ? 'bg-blue-50 border-blue-200' : 'bg-white border-gray-200 hover:border-gray-300'"
                        >
                            <div class="flex items-center justify-between mb-2">
                                <span class="font-medium text-gray-900 truncate pr-2">{{ list.title || 'Без названия' }}</span>
                                <span class="text-xs text-gray-400 bg-gray-100 px-1.5 py-0.5 rounded flex-shrink-0">{{ list.purchases.length }}</span>
                            </div>
                            <div class="h-1.5 bg-gray-100 rounded-full overflow-hidden">
                                <div 
                                    class="h-full bg-blue-500 rounded-full transition-all duration-300"
                                    :style="{ width: getListProgress(list) + '%' }"
                                ></div>
                            </div>
                            <div class="flex justify-between mt-1.5 text-xs text-gray-500">
                                <span>{{ formatMoney(getListCompleted(list)) }} ₽</span>
                                <span>{{ getListProgress(list).toFixed(0) }}%</span>
                            </div>
                        </div>
                    </div>
                    
                    <div v-if="trackLists.length === 0" class="text-center py-8 text-gray-400">
                        <i data-lucide="clipboard-list" class="w-10 h-10 mx-auto mb-2 stroke-1"></i>
                        <p class="text-sm">Нет списков</p>
                    </div>
                </div>
            </div>
        </aside>
        
        <!-- Main Content -->
        <main class="lg:ml-[280px] pt-14 lg:pt-0 min-h-screen">
            <!-- Selected List Content -->
            <div v-if="selectedList" class="p-4 lg:p-6 max-w-2xl mx-auto">
                <!-- List Header -->
                <div class="flex items-start justify-between gap-3 mb-6">
                    <div class="flex-1 min-w-0">
                        <input 
                            type="text" 
                            v-model="selectedList.title"
                            @input="saveData"
                            class="text-xl lg:text-2xl font-bold bg-transparent border-b-2 border-transparent hover:border-gray-200 focus:border-blue-500 focus:outline-none w-full"
                            placeholder="Название списка"
                        >
                        <p class="text-gray-500 mt-1 text-sm">
                            {{ selectedList.purchases.length }} {{ getPurchaseWord(selectedList.purchases.length) }} • 
                            {{ formatMoney(getListTotalPrice(selectedList)) }} ₽
                        </p>
                    </div>
                    <button 
                        @click="requestDeleteList(selectedList.id)"
                        class="text-gray-400 hover:text-red-500 hover:bg-red-50 p-2 rounded-lg transition-colors flex-shrink-0"
                        title="Удалить список"
                    >
                        <i data-lucide="trash-2" class="w-5 h-5"></i>
                    </button>
                </div>
                
                <!-- Progress Section -->
                <div class="bg-white rounded-xl border border-gray-200 p-4 mb-6">
                    <div class="flex items-center justify-between mb-3">
                        <span class="font-medium text-gray-700">Прогресс</span>
                        <span class="text-xl font-bold" :class="getListProgress(selectedList) >= 100 ? 'text-green-600' : 'text-blue-600'">
                            {{ getListProgress(selectedList).toFixed(0) }}%
                        </span>
                    </div>
                    <div class="h-2 bg-gray-100 rounded-full overflow-hidden mb-4">
                        <div 
                            class="h-full rounded-full transition-all duration-300"
                            :class="getListProgress(selectedList) >= 100 ? 'bg-green-500' : 'bg-blue-500'"
                            :style="{ width: Math.min(getListProgress(selectedList), 100) + '%' }"
                        ></div>
                    </div>
                    
                    <!-- Stats Row -->
                    <div class="flex gap-3">
                        <div class="flex-1 p-3 rounded-lg bg-green-50">
                            <p class="text-xs text-green-600 mb-1">Выполнено</p>
                            <p class="font-bold text-green-700">{{ formatMoney(getListCompleted(selectedList)) }} ₽</p>
                        </div>
                        <div class="flex-1 p-3 rounded-lg bg-orange-50">
                            <p class="text-xs text-orange-600 mb-1">Осталось</p>
                            <p class="font-bold text-orange-700">{{ formatMoney(getListUncompleted(selectedList)) }} ₽</p>
                        </div>
                    </div>
                </div>
                
                <!-- Add Purchase Button -->
                <button 
                    @click="addPurchase(selectedList.id)"
                    class="w-full bg-blue-500 hover:bg-blue-600 text-white rounded-xl py-3 mb-4 transition-colors flex items-center justify-center gap-2 font-medium"
                >
                    <i data-lucide="plus" class="w-5 h-5"></i>
                    <span>Добавить покупку</span>
                </button>
                
                <!-- Purchases List -->
                <div class="space-y-3">
                    <div 
                        v-for="purchase in selectedList.purchases" 
                        :key="purchase.id + '-' + purchase.completed"
                        class="bg-white rounded-xl border overflow-hidden"
                        :class="purchase.completed ? 'border-green-300 bg-green-50' : 'border-gray-200'"
                    >
                        <!-- Purchase Card -->
                        <div class="p-4">
                            <!-- Top Row: Checkbox + Title + Delete -->
                            <div class="flex items-start gap-3 mb-3">
                                <!-- Checkbox -->
                                <label class="relative cursor-pointer flex-shrink-0 mt-0.5">
                                    <input 
                                        type="checkbox" 
                                        v-model="purchase.completed"
                                        @change="handleCompletedChange(purchase)"
                                        class="sr-only peer"
                                    >
                                    <div class="w-6 h-6 rounded-lg border-2 border-gray-300 peer-checked:border-green-500 peer-checked:bg-green-500 transition-all flex items-center justify-center">
                                        <i v-if="purchase.completed" data-lucide="check" class="w-4 h-4 text-white"></i>
                                    </div>
                                </label>
                                
                                <!-- Title Input -->
                                <div class="flex-1 min-w-0">
                                    <input 
                                        type="text" 
                                        v-model="purchase.title"
                                        @input="saveData"
                                        class="w-full bg-transparent font-medium text-base border-b border-transparent hover:border-gray-300 focus:border-blue-500 focus:outline-none pb-1"
                                        :class="{ 'line-through text-gray-400': purchase.completed }"
                                        placeholder="Название покупки"
                                    >
                                </div>
                                
                                <!-- Delete Button -->
                                <button 
                                    @click="requestDeletePurchase(selectedList.id, purchase.id, purchase.title)"
                                    class="flex-shrink-0 text-gray-300 hover:text-red-500 p-1.5 rounded-lg hover:bg-red-50 transition-colors"
                                >
                                    <i data-lucide="trash-2" class="w-4 h-4"></i>
                                </button>
                            </div>
                            
                            <!-- Price Row (only for uncompleted) -->
                            <div v-if="!purchase.completed" class="flex items-center gap-3 mb-3">
                                <span class="text-sm text-gray-500">Цена:</span>
                                <div class="relative flex-1 max-w-[140px]">
                                    <input 
                                        type="number" 
                                        v-model.number="purchase.price"
                                        @input="handlePriceChange(purchase)"
                                        class="w-full border border-gray-200 rounded-lg px-3 py-2 pr-8 text-base font-semibold focus:ring-2 focus:ring-blue-500 focus:border-blue-500 focus:outline-none"
                                        placeholder="0"
                                        min="0"
                                    >
                                    <span class="absolute right-3 top-1/2 -translate-y-1/2 text-gray-400">₽</span>
                                </div>
                                
                                <!-- Budget Coverage Indicator -->
                                <div 
                                    v-if="(purchase.price - (purchase.paid || 0)) > 0"
                                    class="flex items-center gap-1.5 px-2 py-1 rounded-lg text-xs font-medium"
                                    :class="getPurchaseCoverage(purchase) >= 100 ? 'bg-green-100 text-green-700' : getPurchaseCoverage(purchase) >= 50 ? 'bg-orange-100 text-orange-700' : 'bg-red-100 text-red-700'"
                                >
                                    <i data-lucide="percent" class="w-3 h-3"></i>
                                    <span>{{ getPurchaseCoverage(purchase).toFixed(0) }}%</span>
                                </div>
                            </div>
                            
                            <!-- Partial Payment Section -->
                            <div v-if="!purchase.completed">
                                <!-- Enable Partial Payment Button -->
                                <button 
                                    v-if="!purchase.partiallyPaid"
                                    @click="enablePartialPayment(purchase)"
                                    class="text-sm text-blue-600 hover:text-blue-700 flex items-center gap-1.5 transition-colors py-1"
                                >
                                    <i data-lucide="coins" class="w-4 h-4"></i>
                                    Добавить частичную оплату
                                </button>
                                
                                <!-- Partial Payment Input -->
                                <div v-if="purchase.partiallyPaid" class="bg-blue-50 rounded-lg p-3 mt-2">
                                    <div class="flex flex-col gap-3">
                                        <div class="flex items-center justify-between gap-3">
                                            <span class="text-sm text-gray-600">Оплачено:</span>
                                            <div class="relative max-w-[140px]">
                                                <input 
                                                    type="number" 
                                                    v-model.number="purchase.paid"
                                                    @input="handlePaidChange(purchase)"
                                                    :max="purchase.price"
                                                    min="0"
                                                    class="w-full border border-blue-200 rounded-lg px-3 py-2 pr-8 text-base font-semibold focus:ring-2 focus:ring-blue-500 focus:border-blue-500 focus:outline-none bg-white"
                                                    placeholder="0"
                                                >
                                                <span class="absolute right-3 top-1/2 -translate-y-1/2 text-gray-400">₽</span>
                                            </div>
                                        </div>
                                        <div class="flex items-center justify-between">
                                            <span class="text-sm text-gray-600">
                                                Осталось: <span class="font-semibold text-orange-600">{{ formatMoney((purchase.price || 0) - (purchase.paid || 0)) }} ₽</span>
                                            </span>
                                            <button 
                                                @click="disablePartialPayment(purchase)"
                                                class="text-sm text-red-500 hover:text-red-600 transition-colors"
                                            >
                                                Убрать
                                            </button>
                                        </div>
                                    </div>
                                </div>
                            </div>
                            
                            <!-- Completed Badge -->
                            <div v-if="purchase.completed" class="flex items-center gap-2 text-green-600 mt-1">
                                <i data-lucide="check-circle" class="w-4 h-4"></i>
                                <span class="text-sm font-medium">Оплачено: {{ formatMoney(purchase.paid) }} ₽</span>
                            </div>
                        </div>
                    </div>
                </div>
                
                <!-- Empty State -->
                <div v-if="selectedList.purchases.length === 0" class="text-center py-16">
                    <div class="w-20 h-20 bg-gray-100 rounded-full flex items-center justify-center mx-auto mb-4">
                        <i data-lucide="shopping-bag" class="w-10 h-10 text-gray-300"></i>
                    </div>
                    <h3 class="text-lg font-medium text-gray-700 mb-1">Список пуст</h3>
                    <p class="text-gray-500 text-sm">Добавьте первую покупку</p>
                </div>
            </div>
            
            <!-- No List Selected -->
            <div v-else class="min-h-[calc(100vh-56px)] lg:min-h-screen flex items-center justify-center p-6">
                <div class="text-center w-full max-w-xs">
                    <div class="w-24 h-24 bg-gray-100 rounded-full flex items-center justify-center mx-auto mb-6">
                        <i data-lucide="layout-list" class="w-12 h-12 text-gray-300"></i>
                    </div>
                    <h2 class="text-xl font-bold text-gray-800 mb-2">Выберите список</h2>
                    <p class="text-gray-500 text-sm mb-8">Выберите список в меню или создайте новый</p>
                    
                    <div class="bg-white rounded-xl border border-gray-200 p-4">
                        <input 
                            type="text" 
                            v-model="newListTitle" 
                            @keyup.enter="addList"
                            class="w-full border border-gray-300 rounded-lg px-4 py-3 text-base focus:ring-2 focus:ring-blue-500 focus:border-blue-500 focus:outline-none mb-3"
                            placeholder="Название списка..."
                        >
                        <button 
                            @click="addList"
                            class="w-full bg-blue-500 hover:bg-blue-600 px-4 py-3 rounded-lg text-white font-medium transition-colors"
                        >
                            Создать список
                        </button>
                    </div>
                    
                </div>
            </div>
        </main>
    </div>

    <script>
        const { createApp, ref, computed, watch, onMounted, nextTick } = Vue;

        createApp({
            setup() {
                const budget = ref(0);
                const trackLists = ref([]);
                const newListTitle = ref('');
                const selectedListId = ref(null);
                const sidebarOpen = ref(false);
                
                // Toast system
                const toasts = ref([]);
                const toastId = ref(0);
                
                const showToast = (message, type = 'info') => {
                    const id = ++toastId.value;
                    toasts.value.push({ id, message, type });
                    setTimeout(() => removeToast(id), 3000);
                    nextTick(() => lucide.createIcons());
                };
                
                const removeToast = (id) => {
                    toasts.value = toasts.value.filter(t => t.id !== id);
                };
                
                const getToastIcon = (type) => {
                    const icons = {
                        success: 'check-circle',
                        error: 'x-circle',
                        warning: 'alert-triangle',
                        info: 'info'
                    };
                    return icons[type] || 'info';
                };
                
                // Confirm modal system
                const confirmModal = ref({
                    show: false,
                    title: '',
                    message: '',
                    onConfirm: null
                });
                
                const showConfirm = (title, message, onConfirm) => {
                    confirmModal.value = {
                        show: true,
                        title,
                        message,
                        onConfirm
                    };
                    nextTick(() => lucide.createIcons());
                };
                
                const executeConfirm = () => {
                    if (confirmModal.value.onConfirm) {
                        confirmModal.value.onConfirm();
                    }
                    confirmModal.value.show = false;
                };
                
                const cancelConfirm = () => {
                    confirmModal.value.show = false;
                };
                
                const generateId = () => Date.now().toString(36) + Math.random().toString(36).substr(2);
                
                const formatMoney = (value) => {
                    if (!value && value !== 0) return '0';
                    return new Intl.NumberFormat('ru-RU').format(value);
                };
                
                const getPurchaseWord = (count) => {
                    const lastTwo = count % 100;
                    const lastOne = count % 10;
                    if (lastTwo >= 11 && lastTwo <= 14) return 'покупок';
                    if (lastOne === 1) return 'покупка';
                    if (lastOne >= 2 && lastOne <= 4) return 'покупки';
                    return 'покупок';
                };
                
                const saveData = () => {
                    localStorage.setItem('trackList_budget', JSON.stringify(budget.value));
                    localStorage.setItem('trackList_lists', JSON.stringify(trackLists.value));
                    localStorage.setItem('trackList_selectedId', JSON.stringify(selectedListId.value));
                };
                
                const loadData = () => {
                    const savedBudget = localStorage.getItem('trackList_budget');
                    const savedLists = localStorage.getItem('trackList_lists');
                    const savedSelectedId = localStorage.getItem('trackList_selectedId');
                    
                    if (savedBudget) budget.value = JSON.parse(savedBudget);
                    if (savedLists) trackLists.value = JSON.parse(savedLists);
                    if (savedSelectedId) selectedListId.value = JSON.parse(savedSelectedId);
                };
                
                const refreshIcons = () => {
                    nextTick(() => {
                        lucide.createIcons();
                        // Дополнительный вызов с задержкой для гарантии обновления после всех изменений DOM
                        setTimeout(() => {
                            lucide.createIcons();
                        }, 50);
                    });
                };
                
                const selectedList = computed(() => {
                    return trackLists.value.find(l => l.id === selectedListId.value) || null;
                });
                
                const selectList = (listId) => {
                    selectedListId.value = listId;
                    saveData();
                    refreshIcons();
                };
                
                const addList = () => {
                    if (!newListTitle.value.trim()) {
                        showToast('Введите название списка', 'warning');
                        return;
                    }
                    
                    const newList = {
                        id: generateId(),
                        title: newListTitle.value.trim(),
                        purchases: []
                    };
                    
                    trackLists.value.push(newList);
                    selectedListId.value = newList.id;
                    newListTitle.value = '';
                    saveData();
                    refreshIcons();
                    showToast('Список создан', 'success');
                };
                
                const requestDeleteList = (listId) => {
                    const list = trackLists.value.find(l => l.id === listId);
                    showConfirm(
                        'Удалить список?',
                        `Список "${list?.title || 'Без названия'}" и все покупки будут удалены.`,
                        () => deleteList(listId)
                    );
                };
                
                const deleteList = (listId) => {
                    const list = trackLists.value.find(l => l.id === listId);
                    const title = list?.title || 'Без названия';
                    
                    trackLists.value = trackLists.value.filter(l => l.id !== listId);
                    if (selectedListId.value === listId) {
                        selectedListId.value = trackLists.value.length > 0 ? trackLists.value[0].id : null;
                    }
                    saveData();
                    refreshIcons();
                    showToast(`Список "${title}" удалён`, 'success');
                };
                
                const addPurchase = (listId) => {
                    const list = trackLists.value.find(l => l.id === listId);
                    if (list) {
                        list.purchases.unshift({
                            id: generateId(),
                            title: '',
                            price: 0,
                            paid: 0,
                            completed: false,
                            partiallyPaid: false
                        });
                        saveData();
                        refreshIcons();
                        showToast('Покупка добавлена', 'success');
                    }
                };
                
                const requestDeletePurchase = (listId, purchaseId, title) => {
                    showConfirm(
                        'Удалить покупку?',
                        `Покупка "${title || 'Без названия'}" будет удалена.`,
                        () => deletePurchase(listId, purchaseId)
                    );
                };
                
                const deletePurchase = (listId, purchaseId) => {
                    const list = trackLists.value.find(l => l.id === listId);
                    if (list) {
                        list.purchases = list.purchases.filter(p => p.id !== purchaseId);
                        saveData();
                        showToast('Покупка удалена', 'success');
                    }
                };
                
                const handleCompletedChange = (purchase) => {
                    if (purchase.completed) {
                        // Отмечаем как выполненную
                        if (!purchase.partiallyPaid) {
                            purchase.paid = purchase.price;
                        }
                        purchase.partiallyPaid = false;
                        showToast('Покупка выполнена', 'success');
                    } else {
                        // Снимаем отметку выполнения - сбрасываем оплату
                        purchase.paid = 0;
                        purchase.partiallyPaid = false;
                    }
                    saveData();
                    refreshIcons();
                };
                
                const handlePriceChange = (purchase) => {
                    if (purchase.paid > purchase.price) {
                        purchase.paid = purchase.price;
                    }
                    if (purchase.completed && !purchase.partiallyPaid) {
                        purchase.paid = purchase.price;
                    }
                    saveData();
                };
                
                const handlePaidChange = (purchase) => {
                    // Защита от пустых/некорректных значений
                    if (purchase.paid === null || purchase.paid === undefined || purchase.paid === '' || isNaN(purchase.paid)) {
                        purchase.paid = 0;
                    }
                    if (purchase.paid < 0) purchase.paid = 0;
                    if (purchase.paid > purchase.price) purchase.paid = purchase.price;
                    
                    if (purchase.paid === purchase.price && purchase.price > 0) {
                        purchase.completed = true;
                        purchase.partiallyPaid = false;
                        showToast('Покупка полностью оплачена', 'success');
                    } else if (purchase.paid === 0) {
                        // Не убираем partiallyPaid при нуле - пользователь может захотеть ввести сумму
                    }
                    saveData();
                    refreshIcons();
                };
                
                const enablePartialPayment = (purchase) => {
                    purchase.partiallyPaid = true;
                    purchase.completed = false;
                    if (!purchase.paid || purchase.paid < 0) {
                        purchase.paid = 0;
                    }
                    saveData();
                    refreshIcons();
                };
                
                const disablePartialPayment = (purchase) => {
                    purchase.partiallyPaid = false;
                    purchase.paid = 0;
                    saveData();
                };
                
                const getListProgress = (list) => {
                    const totalPrice = list.purchases.reduce((sum, p) => sum + (p.price || 0), 0);
                    if (totalPrice === 0) return 0;
                    const totalPaid = list.purchases.reduce((sum, p) => sum + (p.paid || 0), 0);
                    return (totalPaid / totalPrice) * 100;
                };
                
                const getListTotalPrice = (list) => {
                    return list.purchases.reduce((sum, p) => sum + (p.price || 0), 0);
                };
                
                const getListCompleted = (list) => {
                    return list.purchases.reduce((sum, p) => sum + (p.paid || 0), 0);
                };
                
                const getListUncompleted = (list) => {
                    return list.purchases.reduce((sum, p) => {
                        if (!p.completed) {
                            return sum + ((p.price || 0) - (p.paid || 0));
                        }
                        return sum;
                    }, 0);
                };
                
                const totalSpent = computed(() => {
                    let total = 0;
                    for (const list of trackLists.value) {
                        for (const p of list.purchases) {
                            // Считаем все оплаченные суммы (и частичные, и полные)
                            // Явно преобразуем в число и обрабатываем null/undefined/NaN
                            let paid = p.paid;
                            if (paid === null || paid === undefined || paid === '') {
                                paid = 0;
                            } else {
                                paid = Number(paid);
                                if (isNaN(paid)) paid = 0;
                            }
                            if (paid > 0) {
                                total += paid;
                            }
                        }
                    }
                    return total;
                });
                
                const remainingBudget = computed(() => {
                    const budgetVal = Number(budget.value) || 0;
                    return budgetVal - totalSpent.value;
                });
                
                const getPurchaseCoverage = (purchase) => {
                    const price = Number(purchase.price) || 0;
                    const paid = Number(purchase.paid) || 0;
                    const unpaidAmount = price - paid;
                    
                    // Если всё оплачено - 100%
                    if (unpaidAmount <= 0) return 100;
                    
                    // Бюджет - это сколько денег есть СЕЙЧАС
                    // Частичные оплаты были сделаны ранее из других денег
                    const budgetVal = Number(budget.value) || 0;
                    
                    // Если бюджета нет - 0%
                    if (budgetVal <= 0) return 0;
                    
                    // Покрытие = бюджет / неоплаченная часть * 100
                    const coverage = (budgetVal / unpaidAmount) * 100;
                    return Math.min(coverage, 100);
                };
                

                
                watch(budget, saveData);
                watch(sidebarOpen, refreshIcons);
                
                onMounted(() => {
                    loadData();
                    refreshIcons();
                });
                
                return {
                    budget,
                    trackLists,
                    newListTitle,
                    selectedListId,
                    selectedList,
                    sidebarOpen,
                    toasts,
                    confirmModal,
                    formatMoney,
                    getPurchaseWord,
                    saveData,
                    selectList,
                    addList,
                    requestDeleteList,
                    deleteList,
                    addPurchase,
                    requestDeletePurchase,
                    deletePurchase,
                    handleCompletedChange,
                    handlePriceChange,
                    handlePaidChange,
                    enablePartialPayment,
                    disablePartialPayment,
                    getListProgress,
                    getListTotalPrice,
                    getListCompleted,
                    getListUncompleted,
                    getPurchaseCoverage,
                    totalSpent,
                    remainingBudget,
                    showToast,
                    removeToast,
                    getToastIcon,
                    showConfirm,
                    executeConfirm,
                    cancelConfirm
                };
            }
        }).mount('#app');
    </script>
</body>
</html>
